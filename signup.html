<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up - SafeGuard | Women Security System</title>
    <meta name="description" content="Create your SafeGuard account to access advanced women security features, emergency assistance, and 24/7 protection.">
    <link rel="stylesheet" href="{{ url_for('static', filename='landing-unified.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='auth-styles.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üõ°Ô∏è</text></svg>">
</head>
<body class="auth-page signup-page">
    <!-- Background Effects -->
    <div class="auth-background">
        <div class="bg-gradient"></div>
        <div class="bg-pattern"></div>
        <div class="bg-shapes">
            <div class="shape shape-1"></div>
            <div class="shape shape-2"></div>
            <div class="shape shape-3"></div>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="auth-nav">
        <div class="nav-brand">
            <div class="brand-icon">
                <i class="fas fa-shield-alt"></i>
            </div>
            <div class="brand-text">
                <span class="brand-name">SafeGuard</span>
                <span class="brand-tagline">Women Security System</span>
            </div>
        </div>
        <div class="nav-links">
            <a href="{{ url_for('landing') }}" class="nav-link">
                <i class="fas fa-home"></i>
                Home
            </a>
            <a href="{{ url_for('signin') }}" class="nav-link nav-link-highlighted">
                <i class="fas fa-sign-in-alt"></i>
                Sign In
            </a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="auth-main">
        <div class="auth-container">
            <!-- Auth Card -->
            <div class="auth-card">
                <!-- Card Header -->
                <header class="auth-card-header">
                    <div class="auth-logo">
                        <div class="logo-circle">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <h1>Create Your Account</h1>
                        <p>Join SafeGuard for enhanced security and peace of mind</p>
                    </div>
                </header>

                <!-- Sign Up Form -->
                <form class="auth-form" id="signupForm" novalidate>
                    <!-- Name Fields Row -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="signupFirstName">
                                <i class="fas fa-user"></i>
                                First Name
                            </label>
                            <div class="input-wrapper">
                                <input
                                    type="text"
                                    id="signupFirstName"
                                    name="firstName"
                                    placeholder="Enter your first name"
                                    required
                                    autocomplete="given-name"
                                >
                                <div class="input-icon">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="input-status">
                                    <i class="fas fa-check"></i>
                                </div>
                            </div>
                            <span class="validation-msg" id="signupFirstNameValidation"></span>
                        </div>

                        <div class="form-group">
                            <label for="signupLastName">
                                <i class="fas fa-user"></i>
                                Last Name
                            </label>
                            <div class="input-wrapper">
                                <input
                                    type="text"
                                    id="signupLastName"
                                    name="lastName"
                                    placeholder="Enter your last name"
                                    required
                                    autocomplete="family-name"
                                >
                                <div class="input-icon">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="input-status">
                                    <i class="fas fa-check"></i>
                                </div>
                            </div>
                            <span class="validation-msg" id="signupLastNameValidation"></span>
                        </div>
                    </div>

                    <!-- Username Field -->
                    <div class="form-group">
                        <label for="signupUsername">
                            <i class="fas fa-at"></i>
                            Username
                        </label>
                        <div class="input-wrapper">
                            <input
                                type="text"
                                id="signupUsername"
                                name="username"
                                placeholder="Choose a unique username"
                                required
                                autocomplete="username"
                            >
                            <div class="input-icon">
                                <i class="fas fa-at"></i>
                            </div>
                            <div class="input-status">
                                <i class="fas fa-check"></i>
                            </div>
                        </div>
                        <span class="validation-msg" id="signupUsernameValidation"></span>
                    </div>

                    <!-- Email Field -->
                    <div class="form-group">
                        <label for="signupEmail">
                            <i class="fas fa-envelope"></i>
                            Email Address
                        </label>
                        <div class="input-wrapper">
                            <input
                                type="email"
                                id="signupEmail"
                                name="email"
                                placeholder="Enter your email address"
                                required
                                autocomplete="email"
                            >
                            <div class="input-icon">
                                <i class="fas fa-envelope"></i>
                            </div>
                            <div class="input-status">
                                <i class="fas fa-check"></i>
                            </div>
                        </div>
                        <span class="validation-msg" id="signupEmailValidation"></span>
                    </div>

                    <!-- Phone Field (Optional) -->
                    <div class="form-group">
                        <label for="signupPhone">
                            <i class="fas fa-phone"></i>
                            Phone Number <span class="optional">(Optional)</span>
                        </label>
                        <div class="input-wrapper">
                            <input
                                type="tel"
                                id="signupPhone"
                                name="phone"
                                placeholder="Enter your phone number"
                                autocomplete="tel"
                            >
                            <div class="input-icon">
                                <i class="fas fa-phone"></i>
                            </div>
                            <div class="input-status">
                                <i class="fas fa-check"></i>
                            </div>
                        </div>
                        <span class="validation-msg" id="signupPhoneValidation"></span>
                    </div>

                    <!-- Password Field -->
                    <div class="form-group">
                        <label for="signupPassword">
                            <i class="fas fa-lock"></i>
                            Password
                        </label>
                        <div class="input-wrapper">
                            <input
                                type="password"
                                id="signupPassword"
                                name="password"
                                placeholder="Create a strong password"
                                required
                                autocomplete="new-password"
                            >
                            <button type="button" class="password-toggle" aria-label="Toggle password visibility">
                                <i class="fas fa-eye"></i>
                            </button>
                            <div class="input-icon">
                                <i class="fas fa-lock"></i>
                            </div>
                            <div class="input-status">
                                <i class="fas fa-check"></i>
                            </div>
                        </div>
                        <!-- Password Strength Indicator -->
                        <div class="password-strength">
                            <div class="strength-bar">
                                <div class="strength-fill" id="strengthFill"></div>
                            </div>
                            <span class="strength-text" id="strengthText">Enter password</span>
                        </div>
                        <span class="validation-msg" id="signupPasswordValidation"></span>
                    </div>

                    <!-- Confirm Password Field -->
                    <div class="form-group">
                        <label for="confirmPassword">
                            <i class="fas fa-lock"></i>
                            Confirm Password
                        </label>
                        <div class="input-wrapper">
                            <input
                                type="password"
                                id="confirmPassword"
                                name="confirmPassword"
                                placeholder="Confirm your password"
                                required
                                autocomplete="new-password"
                            >
                            <button type="button" class="password-toggle" aria-label="Toggle password visibility">
                                <i class="fas fa-eye"></i>
                            </button>
                            <div class="input-icon">
                                <i class="fas fa-lock"></i>
                            </div>
                            <div class="input-status">
                                <i class="fas fa-check"></i>
                            </div>
                        </div>
                        <span class="validation-msg" id="confirmPasswordValidation"></span>
                    </div>

                    <!-- Authentication Method Toggle -->
                    <div class="auth-method-section">
                        <div class="method-tabs">
                            <button type="button" class="method-tab active" data-method="password">
                                <i class="fas fa-key"></i>
                                <span>Password</span>
                            </button>
                            <button type="button" class="method-tab" data-method="pattern">
                                <i class="fas fa-th"></i>
                                <span>Pattern Lock</span>
                            </button>
                        </div>
                        <p class="method-description">Set up your preferred authentication method</p>
                    </div>

                    <!-- Pattern Lock Section -->
                    <div id="signupPatternSection" class="pattern-lock-section" style="display: none;">
                        <div class="pattern-lock-container">
                            <div id="signupPatternLock"></div>
                        </div>
                        <p class="pattern-hint">
                            <i class="fas fa-info-circle"></i>
                            Create a pattern lock as an alternative security method for your account.
                        </p>
                    </div>

                    <!-- Agreements -->
                    <div class="form-group">
                        <label class="checkbox-wrapper agreement">
                            <input type="checkbox" id="agreeTerms" required>
                            <span class="checkmark"></span>
                            <span>I agree to the <a href="#" class="link">Terms of Service</a> and <a href="#" class="link">Privacy Policy</a></span>
                        </label>
                        <span class="validation-msg" id="agreeTermsValidation"></span>
                    </div>

                    <div class="form-group">
                        <label class="checkbox-wrapper">
                            <input type="checkbox" id="newsletter">
                            <span class="checkmark"></span>
                            <span>Subscribe to safety tips and security updates</span>
                        </label>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" class="btn btn-primary btn-full">
                        <i class="fas fa-user-plus"></i>
                        <span>Create SafeGuard Account</span>
                        <div class="btn-loading"></div>
                    </button>
                </form>

                <!-- Social Sign Up -->
                <div class="social-section">
                    <div class="social-divider">
                        <span>Or sign up with</span>
                    </div>
                    <div class="social-buttons">
                        <button class="social-btn google">
                            <i class="fab fa-google"></i>
                            <span>Google</span>
                        </button>
                        <button class="social-btn facebook">
                            <i class="fab fa-facebook-f"></i>
                            <span>Facebook</span>
                        </button>
                    </div>
                </div>

                <!-- Sign In Link -->
                <div class="auth-switch">
                    <p>Already have an account? <a href="{{ url_for('signin') }}">Sign in here</a></p>
                </div>

                <!-- Message Display -->
                <div id="signupMessage" class="auth-message"></div>
            </div>

            <!-- Security Info -->
            <div class="security-info">
                <div class="security-badges">
                    <div class="badge">
                        <i class="fas fa-shield-alt"></i>
                        <span>256-bit Encryption</span>
                    </div>
                    <div class="badge">
                        <i class="fas fa-lock"></i>
                        <span>Secure & Private</span>
                    </div>
                    <div class="badge">
                        <i class="fas fa-certificate"></i>
                        <span>GDPR Compliant</span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- JavaScript -->
    <script src="{{ url_for('static', filename='simple_working_pattern_lock.js') }}"></script>
    <script src="{{ url_for('static', filename='auth-enhanced.js') }}"></script>
    <script>
        // Sign Up Page specific functionality
        class SignUpPage {
            constructor() {
                this.currentAuthMethod = 'password';
                this.patternLock = null;
                this.registerPattern = null;
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.initializePatternLock();
                this.setupValidation();
            }

            setupEventListeners() {
                // Form submission
                document.getElementById('signupForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleSignUp();
                });

                // Authentication method toggle
                document.querySelectorAll('.method-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        const method = e.target.closest('.method-tab').dataset.method;
                        this.switchAuthMethod(method);
                    });
                });

                // Password toggle
                document.querySelectorAll('.password-toggle').forEach(button => {
                    button.addEventListener('click', (e) => {
                        this.togglePassword(e.target.closest('.password-toggle'));
                    });
                });
            }

            setupValidation() {
                // Password confirmation
                const password = document.getElementById('signupPassword');
                const confirmPassword = document.getElementById('confirmPassword');

                if (password && confirmPassword) {
                    confirmPassword.addEventListener('input', () => {
                        this.validatePasswordMatch();
                    });
                    
                    // Password strength
                    password.addEventListener('input', () => {
                        this.updatePasswordStrength(password.value);
                    });
                }

                // Real-time field validation
                const fields = ['signupUsername', 'signupEmail', 'signupPassword', 'confirmPassword'];
                fields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.addEventListener('input', () => {
                            this.validateField(field);
                        });
                    }
                });
            }

            validatePasswordMatch() {
                const password = document.getElementById('signupPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                const validationDiv = document.getElementById('confirmPasswordValidation');

                if (confirmPassword && password !== confirmPassword) {
                    validationDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> Passwords do not match';
                    validationDiv.className = 'validation-msg invalid show';
                    return false;
                } else if (confirmPassword && password === confirmPassword) {
                    validationDiv.innerHTML = '<i class="fas fa-check"></i> Passwords match';
                    validationDiv.className = 'validation-msg valid show';
                    return true;
                } else {
                    validationDiv.className = 'validation-msg';
                    return true;
                }
            }

            updatePasswordStrength(password) {
                const strengthFill = document.getElementById('strengthFill');
                const strengthText = document.getElementById('strengthText');
                
                let strength = 0;
                let text = 'Weak';
                let color = '#dc2626';

                if (password.length >= 8) strength += 1;
                if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength += 1;
                if (/\d/.test(password)) strength += 1;
                if (/[^a-zA-Z0-9]/.test(password)) strength += 1;

                switch (strength) {
                    case 0:
                        text = 'Too short';
                        color = '#dc2626';
                        break;
                    case 1:
                        text = 'Weak';
                        color = '#f59e0b';
                        break;
                    case 2:
                        text = 'Fair';
                        color = '#f59e0b';
                        break;
                    case 3:
                        text = 'Good';
                        color = '#10b981';
                        break;
                    case 4:
                        text = 'Strong';
                        color = '#059669';
                        break;
                }

                if (strengthFill) {
                    strengthFill.style.width = (strength * 25) + '%';
                    strengthFill.style.background = color;
                }
                if (strengthText) {
                    strengthText.textContent = text;
                    strengthText.style.color = color;
                }
            }

            validateField(input) {
                const value = input.value.trim();
                const validationDiv = document.getElementById(input.id + 'Validation');

                if (!validationDiv) return;

                let isValid = true;
                let message = '';

                // Username validation
                if (input.id === 'signupUsername') {
                    if (value.length < 3) {
                        isValid = false;
                        message = 'Username must be at least 3 characters';
                    } else if (!/^[a-zA-Z0-9_]+$/.test(value)) {
                        isValid = false;
                        message = 'Username can only contain letters, numbers, and underscores';
                    }
                }

                // Email validation
                if (input.id === 'signupEmail') {
                    if (value && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) {
                        isValid = false;
                        message = 'Please enter a valid email address';
                    }
                }

                // Password validation
                if (input.id === 'signupPassword') {
                    if (value.length < 8) {
                        isValid = false;
                        message = 'Password must be at least 8 characters';
                    } else if (!/(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/.test(value)) {
                        isValid = false;
                        message = 'Password must contain uppercase, lowercase, and numbers';
                    }
                }

                // Update validation UI
                if (isValid && value) {
                    validationDiv.innerHTML = '<i class="fas fa-check"></i>';
                    validationDiv.className = 'validation-msg valid show';
                } else if (!isValid && value) {
                    validationDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
                    validationDiv.className = 'validation-msg invalid show';
                } else {
                    validationDiv.className = 'validation-msg';
                }
            }

            switchAuthMethod(method) {
                this.currentAuthMethod = method;

                // Update active tab
                document.querySelectorAll('.method-tab').forEach(tab => {
                    tab.classList.remove('active');
                    tab.setAttribute('aria-selected', 'false');
                });
                const activeTab = document.querySelector(`[data-method="${method}"]`);
                activeTab.classList.add('active');
                activeTab.setAttribute('aria-selected', 'true');

                // Show/hide appropriate sections
                const passwordFields = document.querySelectorAll('.form-group:not(.auth-method-section)');
                const patternSection = document.getElementById('signupPatternSection');

                if (method === 'pattern') {
                    passwordFields.forEach(field => {
                        const passwordInput = field.querySelector('input[type="password"]');
                        if (passwordInput && !field.querySelector('#confirmPassword')) {
                            field.style.display = 'none';
                        }
                    });
                    patternSection.style.display = 'block';
                } else {
                    passwordFields.forEach(field => {
                        field.style.display = 'block';
                    });
                    patternSection.style.display = 'none';
                }
            }

            togglePassword(button) {
                const input = button.parentElement.querySelector('input');
                const icon = button.querySelector('i');

                if (input.type === 'password') {
                    input.type = 'text';
                    icon.className = 'fas fa-eye-slash';
                } else {
                    input.type = 'password';
                    icon.className = 'fas fa-eye';
                }
            }

            initializePatternLock() {
                if (typeof SimpleWorkingPatternLock === 'undefined') {
                    console.warn('SimpleWorkingPatternLock not found');
                    return;
                }

                const container = document.getElementById('signupPatternLock');
                if (container && !this.patternLock) {
                    this.patternLock = new SimpleWorkingPatternLock('signupPatternLock', {
                        title: 'Set Pattern Lock',
                        subtitle: 'Create your security pattern',
                        minDots: 4,
                        onComplete: (pattern) => this.handlePatternSet(pattern)
                    });
                }
            }

            handlePatternSet(pattern) {
                this.registerPattern = pattern;
                this.showMessage('Pattern set successfully! You can now create your account.', 'success');
            }

            async handleSignUp() {
                const form = document.getElementById('signupForm');
                const formData = new FormData(form);
                const submitBtn = form.querySelector('button[type="submit"]');
                const originalContent = submitBtn.innerHTML;

                try {
                    // Validate form
                    if (!this.validateForm()) {
                        this.showMessage('Please check the form for errors.', 'error');
                        return;
                    }

                    // Validate password match
                    if (this.currentAuthMethod === 'password' && !this.validatePasswordMatch()) {
                        this.showMessage('Please ensure passwords match.', 'error');
                        return;
                    }

                    // Show loading state
                    submitBtn.classList.add('loading');
                    submitBtn.disabled = true;

                    const data = {
                        firstName: formData.get('firstName'),
                        lastName: formData.get('lastName'),
                        username: formData.get('username'),
                        email: formData.get('email'),
                        phone: formData.get('phone'),
                        password: formData.get('password'),
                        pattern: this.currentAuthMethod === 'pattern' ? this.registerPattern : null
                    };

                    // Validate pattern if using pattern lock
                    if (this.currentAuthMethod === 'pattern' && (!data.pattern || data.pattern.length < 4)) {
                        this.showMessage('Please set up your pattern lock first!', 'error');
                        return;
                    }

                    const response = await fetch('/register', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();

                    if (result.success) {
                        this.showMessage(result.message, 'success');

                        // Switch to sign in page after successful registration
                        setTimeout(() => {
                            window.location.href = '/signin';
                        }, 2000);
                    } else {
                        this.showMessage(result.message, 'error');
                    }
                } catch (error) {
                    this.showMessage('Network error. Please try again.', 'error');
                } finally {
                    // Reset button state
                    submitBtn.classList.remove('loading');
                    submitBtn.disabled = false;
                    this.hideLoading();
                }
            }

            validateForm() {
                let isValid = true;
                const requiredFields = ['signupUsername', 'signupEmail', 'signupPassword', 'confirmPassword'];

                requiredFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field && !field.value.trim()) {
                        isValid = false;
                        this.validateField(field);
                    }
                });

                // Check terms agreement
                const agreeTerms = document.getElementById('agreeTerms');
                const termsValidation = document.getElementById('agreeTermsValidation');
                if (agreeTerms && !agreeTerms.checked) {
                    isValid = false;
                    termsValidation.innerHTML = '<i class="fas fa-exclamation-circle"></i> You must agree to the terms';
                    termsValidation.className = 'validation-msg invalid show';
                } else if (termsValidation) {
                    termsValidation.className = 'validation-msg';
                }

                return isValid;
            }

            showLoading(message = 'Processing...') {
                let loadingOverlay = document.getElementById('signupLoadingOverlay');
                if (!loadingOverlay) {
                    loadingOverlay = document.createElement('div');
                    loadingOverlay.id = 'signupLoadingOverlay';
                    loadingOverlay.className = 'loading-overlay';
                    loadingOverlay.innerHTML = `
                        <div class="loading-content">
                            <div class="spinner">
                                <div class="shield-spinner">
                                    <i class="fas fa-shield-alt"></i>
                                </div>
                            </div>
                            <h3>Creating Account</h3>
                            <p>${message}</p>
                        </div>
                    `;
                    document.body.appendChild(loadingOverlay);
                } else {
                    loadingOverlay.querySelector('p').textContent = message;
                }
                loadingOverlay.style.display = 'flex';
            }

            hideLoading() {
                const loadingOverlay = document.getElementById('signupLoadingOverlay');
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'none';
                }
            }

            showMessage(message, type = 'info') {
                const messageDiv = document.getElementById('signupMessage');
                if (messageDiv) {
                    const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle';
                    messageDiv.innerHTML = `
                        <div class="message ${type}">
                            <i class="fas fa-${icon}"></i>
                            <span>${message}</span>
                            <button class="message-close" onclick="this.parentElement.parentElement.style.display='none'">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                    messageDiv.style.display = 'block';

                    // Auto-hide after 5 seconds
                    setTimeout(() => {
                        if (messageDiv) messageDiv.style.display = 'none';
                    }, 5000);
                }
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            new SignUpPage();
        });
    </script>
</body>
</html>
