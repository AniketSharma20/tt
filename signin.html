<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign In - SafeGuard | Women Security System</title>
    <meta name="description" content="Sign in to your SafeGuard account to access your personal security dashboard and emergency features.">
    <link rel="stylesheet" href="{{ url_for('static', filename='landing-unified.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='auth-styles.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üõ°Ô∏è</text></svg>">
</head>
<body class="auth-page">
    <!-- Background Effects -->
    <div class="auth-background">
        <div class="bg-gradient"></div>
        <div class="bg-pattern"></div>
        <div class="bg-shapes">
            <div class="shape shape-1"></div>
            <div class="shape shape-2"></div>
            <div class="shape shape-3"></div>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="auth-nav">
        <div class="nav-brand">
            <div class="brand-icon">
                <i class="fas fa-shield-alt"></i>
            </div>
            <div class="brand-text">
                <span class="brand-name">SafeGuard</span>
                <span class="brand-tagline">Women Security System</span>
            </div>
        </div>
        <div class="nav-links">
            <a href="{{ url_for('landing') }}" class="nav-link">
                <i class="fas fa-home"></i>
                Home
            </a>
            <a href="{{ url_for('signup') }}" class="nav-link nav-link-highlighted">
                <i class="fas fa-user-plus"></i>
                Sign Up
            </a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="auth-main">
        <div class="auth-container">
            <!-- Auth Card -->
            <div class="auth-card">
                <!-- Card Header -->
                <header class="auth-card-header">
                    <div class="auth-logo">
                        <div class="logo-circle">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <h1>Welcome Back</h1>
                        <p>Sign in to access your security dashboard</p>
                    </div>
                </header>

                <!-- Sign In Form -->
                <form class="auth-form" id="signinForm" novalidate>
                    <!-- Username Field -->
                    <div class="form-group">
                        <label for="signinUsername">
                            <i class="fas fa-user"></i>
                            Username or Email
                        </label>
                        <div class="input-wrapper">
                            <input
                                type="text"
                                id="signinUsername"
                                name="username"
                                placeholder="Enter your username or email"
                                required
                                autocomplete="username"
                            >
                            <div class="input-icon">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="input-status">
                                <i class="fas fa-check"></i>
                            </div>
                        </div>
                        <span class="validation-msg" id="signinUsernameValidation"></span>
                    </div>

                    <!-- Password Field -->
                    <div class="form-group">
                        <label for="signinPassword">
                            <i class="fas fa-lock"></i>
                            Password
                        </label>
                        <div class="input-wrapper">
                            <input
                                type="password"
                                id="signinPassword"
                                name="password"
                                placeholder="Enter your password"
                                required
                                autocomplete="current-password"
                            >
                            <button type="button" class="password-toggle" aria-label="Toggle password visibility">
                                <i class="fas fa-eye"></i>
                            </button>
                            <div class="input-icon">
                                <i class="fas fa-lock"></i>
                            </div>
                            <div class="input-status">
                                <i class="fas fa-check"></i>
                            </div>
                        </div>
                        <span class="validation-msg" id="signinPasswordValidation"></span>
                    </div>

                    <!-- Remember Me & Forgot Password -->
                    <div class="form-options">
                        <label class="checkbox-wrapper">
                            <input type="checkbox" id="rememberMe">
                            <span class="checkmark"></span>
                            <span>Remember me</span>
                        </label>
                        <a href="#" class="forgot-link">Forgot Password?</a>
                    </div>

                    <!-- Authentication Method Toggle -->
                    <div class="auth-method-section">
                        <div class="method-tabs">
                            <button type="button" class="method-tab active" data-method="password">
                                <i class="fas fa-key"></i>
                                <span>Password</span>
                            </button>
                            <button type="button" class="method-tab" data-method="pattern">
                                <i class="fas fa-th"></i>
                                <span>Pattern Lock</span>
                            </button>
                        </div>
                    </div>

                    <!-- Pattern Lock Section -->
                    <div id="signinPatternSection" class="pattern-lock-section" style="display: none;">
                        <div class="pattern-lock-container">
                            <div id="signinPatternLock"></div>
                        </div>
                        <p class="pattern-hint">
                            <i class="fas fa-info-circle"></i>
                            Draw your security pattern to sign in
                        </p>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" class="btn btn-primary btn-full">
                        <i class="fas fa-sign-in-alt"></i>
                        <span>Sign In to SafeGuard</span>
                        <div class="btn-loading"></div>
                    </button>
                </form>

                <!-- Social Login -->
                <div class="social-section">
                    <div class="social-divider">
                        <span>Or continue with</span>
                    </div>
                    <div class="social-buttons">
                        <button class="social-btn google">
                            <i class="fab fa-google"></i>
                            <span>Google</span>
                        </button>
                        <button class="social-btn facebook">
                            <i class="fab fa-facebook-f"></i>
                            <span>Facebook</span>
                        </button>
                    </div>
                </div>

                <!-- Sign Up Link -->
                <div class="auth-switch">
                    <p>Don't have an account? <a href="{{ url_for('signup') }}">Sign up here</a></p>
                </div>

                <!-- Message Display -->
                <div id="signinMessage" class="auth-message"></div>
            </div>

            <!-- Security Info -->
            <div class="security-info">
                <div class="security-badges">
                    <div class="badge">
                        <i class="fas fa-shield-alt"></i>
                        <span>256-bit Encryption</span>
                    </div>
                    <div class="badge">
                        <i class="fas fa-lock"></i>
                        <span>Secure & Private</span>
                    </div>
                    <div class="badge">
                        <i class="fas fa-certificate"></i>
                        <span>GDPR Compliant</span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- JavaScript -->
    <script src="{{ url_for('static', filename='simple_working_pattern_lock.js') }}"></script>
    <script src="{{ url_for('static', filename='auth-enhanced.js') }}"></script>
    <script>
        // Sign In Page specific functionality
        class SignInPage {
            constructor() {
                this.currentAuthMethod = 'password';
                this.patternLock = null;
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.initializePatternLock();
                this.loadRememberedUsername();
            }

            setupEventListeners() {
                // Form submission
                document.getElementById('signinForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleSignIn();
                });

                // Authentication method toggle
                document.querySelectorAll('.method-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        const method = e.target.closest('.method-tab').dataset.method;
                        this.switchAuthMethod(method);
                    });
                });

                // Password toggle
                document.querySelectorAll('.password-toggle').forEach(button => {
                    button.addEventListener('click', (e) => {
                        this.togglePassword(e.target.closest('.password-toggle'));
                    });
                });
            }

            switchAuthMethod(method) {
                this.currentAuthMethod = method;

                // Update active tab
                document.querySelectorAll('.method-tab').forEach(tab => {
                    tab.classList.remove('active');
                    tab.setAttribute('aria-selected', 'false');
                });
                const activeTab = document.querySelector(`[data-method="${method}"]`);
                activeTab.classList.add('active');
                activeTab.setAttribute('aria-selected', 'true');

                // Show/hide appropriate sections
                const passwordFields = document.querySelectorAll('.form-group:not(.auth-method-section)');
                const patternSection = document.getElementById('signinPatternSection');

                if (method === 'pattern') {
                    passwordFields.forEach(field => {
                        const passwordInput = field.querySelector('input[type="password"]');
                        if (passwordInput && field.id !== 'signinUsernameValidation') {
                            field.style.display = 'none';
                        }
                    });
                    patternSection.style.display = 'block';
                } else {
                    passwordFields.forEach(field => {
                        field.style.display = 'block';
                    });
                    patternSection.style.display = 'none';
                }
            }

            togglePassword(button) {
                const input = button.parentElement.querySelector('input');
                const icon = button.querySelector('i');

                if (input.type === 'password') {
                    input.type = 'text';
                    icon.className = 'fas fa-eye-slash';
                } else {
                    input.type = 'password';
                    icon.className = 'fas fa-eye';
                }
            }

            initializePatternLock() {
                if (typeof SimpleWorkingPatternLock === 'undefined') {
                    console.warn('SimpleWorkingPatternLock not found');
                    return;
                }

                const container = document.getElementById('signinPatternLock');
                if (container && !this.patternLock) {
                    this.patternLock = new SimpleWorkingPatternLock('signinPatternLock', {
                        title: 'Enter Pattern Lock',
                        subtitle: 'Draw your pattern to sign in',
                        minDots: 4,
                        onComplete: (pattern) => this.handlePatternSignIn(pattern)
                    });
                }
            }

            async handlePatternSignIn(pattern) {
                const username = document.getElementById('signinUsername').value;

                if (!username) {
                    this.showMessage('Please enter your username first', 'error');
                    return;
                }

                try {
                    this.showLoading('Signing in with pattern...');

                    const response = await fetch('/login-pattern', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, pattern })
                    });

                    const result = await response.json();

                    if (result.success) {
                        this.showMessage(result.message, 'success');
                        setTimeout(() => window.location.href = '/dashboard', 1500);
                    } else {
                        this.showMessage(result.message, 'error');
                    }
                } catch (error) {
                    this.showMessage('Network error. Please try again.', 'error');
                } finally {
                    this.hideLoading();
                }
            }

            async handleSignIn() {
                const form = document.getElementById('signinForm');
                const formData = new FormData(form);
                const submitBtn = form.querySelector('button[type="submit"]');
                const originalContent = submitBtn.innerHTML;

                try {
                    // Show loading state
                    submitBtn.classList.add('loading');
                    submitBtn.disabled = true;

                    const data = {
                        username: formData.get('username'),
                        password: formData.get('password')
                    };

                    const response = await fetch('/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();

                    if (result.success) {
                        this.showMessage(result.message, 'success');

                        // Store remember me preference
                        const rememberMe = document.getElementById('rememberMe');
                        if (rememberMe && rememberMe.checked) {
                            localStorage.setItem('rememberUsername', data.username);
                        }

                        setTimeout(() => window.location.href = '/dashboard', 1500);
                    } else {
                        this.showMessage(result.message, 'error');
                    }
                } catch (error) {
                    this.showMessage('Network error. Please try again.', 'error');
                } finally {
                    // Reset button state
                    submitBtn.classList.remove('loading');
                    submitBtn.disabled = false;
                    this.hideLoading();
                }
            }

            showLoading(message = 'Processing...') {
                let loadingOverlay = document.getElementById('signinLoadingOverlay');
                if (!loadingOverlay) {
                    loadingOverlay = document.createElement('div');
                    loadingOverlay.id = 'signinLoadingOverlay';
                    loadingOverlay.className = 'loading-overlay';
                    loadingOverlay.innerHTML = `
                        <div class="loading-content">
                            <div class="spinner">
                                <div class="shield-spinner">
                                    <i class="fas fa-shield-alt"></i>
                                </div>
                            </div>
                            <h3>Secure Processing</h3>
                            <p>${message}</p>
                        </div>
                    `;
                    document.body.appendChild(loadingOverlay);
                } else {
                    loadingOverlay.querySelector('p').textContent = message;
                }
                loadingOverlay.style.display = 'flex';
            }

            hideLoading() {
                const loadingOverlay = document.getElementById('signinLoadingOverlay');
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'none';
                }
            }

            showMessage(message, type = 'info') {
                const messageDiv = document.getElementById('signinMessage');
                if (messageDiv) {
                    const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle';
                    messageDiv.innerHTML = `
                        <div class="message ${type}">
                            <i class="fas fa-${icon}"></i>
                            <span>${message}</span>
                            <button class="message-close" onclick="this.parentElement.parentElement.style.display='none'">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                    messageDiv.style.display = 'block';

                    // Auto-hide after 5 seconds
                    setTimeout(() => {
                        if (messageDiv) messageDiv.style.display = 'none';
                    }, 5000);
                }
            }

            loadRememberedUsername() {
                const rememberedUsername = localStorage.getItem('rememberUsername');
                if (rememberedUsername) {
                    const usernameField = document.getElementById('signinUsername');
                    const rememberMe = document.getElementById('rememberMe');
                    if (usernameField) usernameField.value = rememberedUsername;
                    if (rememberMe) rememberMe.checked = true;
                }
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            new SignInPage();
        });
    </script>
</body>
</html>
